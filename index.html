<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>ë¹„ìƒ í˜¸ì¶œ</title>
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="ë¹„ìƒ í˜¸ì¶œ">
<meta name="mobile-web-app-capable" content="yes">
<meta name="theme-color" content="#FF1414">
<link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 192 192'%3E%3Crect width='192' height='192' rx='40' fill='%23FF1414'/%3E%3Ctext x='96' y='140' font-size='110' text-anchor='middle'%3E%F0%9F%9A%A8%3C/text%3E%3C/svg%3E">
<link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 192 192'%3E%3Crect width='192' height='192' rx='40' fill='%23FF1414'/%3E%3Ctext x='96' y='140' font-size='110' text-anchor='middle'%3E%F0%9F%9A%A8%3C/text%3E%3C/svg%3E">
<link href="https://fonts.googleapis.com/css2?family=Black+Han+Sans&family=Noto+Sans+KR:wght@400;700;900&display=swap" rel="stylesheet">

<style>
:root {
  --red:#FF1414; --bg:#0D0F1A; --card:#141627; --card2:#1C1F35;
  --yellow:#FFD600; --blue:#0A2550; --green:#00C851; --muted:#5A607A; --white:#EEF2FF;
}
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;}
html,body{height:100%;}
body{font-family:'Noto Sans KR',sans-serif;background:var(--bg);color:var(--white);min-height:100vh;}

.screen{display:none;min-height:100vh;flex-direction:column;}
.screen.active{display:flex;}

/* â”€â”€ SETUP â”€â”€ */
#screen-setup{background:radial-gradient(ellipse at 30% 20%,#1a0a2e 0%,#0D0F1A 70%);align-items:center;justify-content:center;padding:20px;}
.setup-card{width:100%;max-width:400px;background:rgba(255,255,255,0.04);border:1px solid rgba(255,20,20,0.25);border-radius:20px;padding:32px 24px;}
.setup-logo{text-align:center;margin-bottom:20px;}
.setup-logo .emblem{width:68px;height:68px;border-radius:50%;background:linear-gradient(135deg,#c00,#600);margin:0 auto 10px;display:flex;align-items:center;justify-content:center;font-size:32px;box-shadow:0 0 40px rgba(255,0,0,0.4);}
.setup-logo h1{font-family:'Black Han Sans';font-size:21px;}
.setup-logo p{font-size:11px;color:var(--muted);margin-top:3px;}

.tabs{display:flex;gap:8px;margin-bottom:18px;}
.tab-btn{flex:1;padding:9px;border:none;border-radius:8px;cursor:pointer;font-family:'Black Han Sans';font-size:12px;background:rgba(255,255,255,0.06);color:var(--muted);transition:all 0.2s;}
.tab-btn.active{background:var(--red);color:white;}

.pane{display:none;}
.pane.active{display:block;}

.field{margin-bottom:13px;}
.field label{font-size:11px;color:var(--muted);display:block;margin-bottom:4px;font-weight:700;letter-spacing:1px;}
.field input,.field select,.field textarea{width:100%;background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.12);border-radius:9px;padding:11px 14px;color:var(--white);font-size:14px;font-family:'Noto Sans KR';outline:none;transition:border-color 0.2s;}
.field input:focus,.field select:focus,.field textarea:focus{border-color:var(--yellow);}
.field select option{background:#1C1F35;}
.field textarea{resize:vertical;min-height:80px;font-size:12px;line-height:1.7;}

/* ë²ˆí˜¸ ì…ë ¥ í° ìŠ¤íƒ€ì¼ */
.num-input-wrap{position:relative;}
.num-input-wrap input{font-size:28px;font-family:'Black Han Sans';text-align:center;padding:16px;letter-spacing:4px;background:rgba(255,20,20,0.08);border:2px solid rgba(255,20,20,0.3);}
.num-input-wrap input:focus{border-color:var(--red);}
.num-input-hint{text-align:center;font-size:11px;color:var(--muted);margin-top:6px;}

.fb-hint{background:rgba(255,214,0,0.07);border:1px solid rgba(255,214,0,0.2);border-radius:8px;padding:10px 12px;font-size:11px;color:#ccc;line-height:1.8;margin-bottom:14px;}
.fb-hint a{color:var(--yellow);}
.fb-hint strong{color:white;}

.btn-main{width:100%;padding:14px;border:none;border-radius:10px;color:white;font-family:'Black Han Sans';font-size:18px;cursor:pointer;letter-spacing:2px;transition:all 0.15s;margin-top:4px;}
.btn-main:active{transform:scale(0.97);}
.btn-red{background:var(--red);box-shadow:0 4px 20px rgba(255,20,20,0.4);}
.btn-green{background:#1a6b3a;}
.btn-blue{background:var(--blue);}
.btn-danger{background:rgba(255,20,20,0.15);border:1px solid rgba(255,20,20,0.3);color:var(--red);}

/* ê´€ë¦¬ì PIN ëª¨ë‹¬ */
#pin-modal{display:none;position:fixed;inset:0;z-index:7000;background:rgba(0,0,0,0.88);align-items:center;justify-content:center;padding:24px;}
#pin-modal.show{display:flex;}
.pin-box{background:var(--card2);border-radius:18px;padding:28px 22px;width:100%;max-width:300px;text-align:center;border:1px solid rgba(255,255,255,0.1);}
.pin-box h3{font-family:'Black Han Sans';font-size:20px;margin-bottom:6px;}
.pin-box p{font-size:12px;color:var(--muted);margin-bottom:18px;}
.pin-input{width:100%;background:rgba(255,255,255,0.06);border:2px solid rgba(255,214,0,0.3);border-radius:9px;padding:14px;color:var(--white);font-size:24px;font-family:'Black Han Sans';text-align:center;letter-spacing:8px;outline:none;margin-bottom:14px;}
.pin-input:focus{border-color:var(--yellow);}
.pin-btns{display:grid;grid-template-columns:1fr 1fr;gap:10px;}
.pin-cancel{padding:12px;background:rgba(255,255,255,0.07);border:1px solid rgba(255,255,255,0.15);border-radius:10px;color:white;font-family:'Black Han Sans';font-size:15px;cursor:pointer;}
.pin-ok{padding:12px;background:var(--yellow);border:none;border-radius:10px;color:#111;font-family:'Black Han Sans';font-size:15px;cursor:pointer;}

/* â”€â”€ HEADER â”€â”€ */
.hdr{background:linear-gradient(90deg,#08091a,#12152e);padding:11px 14px;display:flex;align-items:center;justify-content:space-between;border-bottom:2px solid rgba(255,20,20,0.5);position:sticky;top:0;z-index:100;flex-shrink:0;}
.hdr-logo{font-family:'Black Han Sans';font-size:17px;display:flex;align-items:center;gap:8px;}
#conn-status{font-size:11px;font-weight:700;}

/* â”€â”€ USER BAR â”€â”€ */
.ubar{background:rgba(255,255,255,0.03);padding:9px 14px;display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid rgba(255,255,255,0.06);font-size:12px;flex-shrink:0;}
.zone-pill{background:var(--blue);padding:4px 10px;border-radius:20px;font-weight:700;font-size:11px;color:#7eb8ff;}
.num-pill{background:var(--red);padding:4px 12px;border-radius:20px;font-family:'Black Han Sans';font-size:14px;color:white;}

.scroll-body{flex:1;overflow-y:auto;padding-bottom:8px;}
.sec-label{font-family:'Black Han Sans';font-size:12px;color:var(--muted);letter-spacing:2px;padding:14px 14px 8px;}

/* â”€â”€ ACTIVE BANNER â”€â”€ */
#active-banner{margin:8px 14px 0;}
.banner-item{padding:12px 14px;display:flex;align-items:center;gap:10px;border-radius:10px;margin-bottom:6px;animation:slideIn 0.3s ease;}
@keyframes slideIn{from{opacity:0;transform:translateY(-6px)}to{opacity:1;transform:translateY(0)}}
.banner-item.br{background:rgba(255,20,20,0.2);border:1px solid rgba(255,20,20,0.4);}
.banner-item.bb{background:rgba(100,100,100,0.2);border:1px solid rgba(150,150,150,0.3);}
.btype{font-family:'Black Han Sans';font-size:11px;padding:3px 8px;border-radius:6px;white-space:nowrap;}
.br .btype{background:var(--red);color:white;}
.bb .btype{background:#555;color:white;}
.binfo{flex:1;}
.bloc{font-weight:700;font-size:13px;}
.bsub{font-size:10px;color:#aaa;}
.btn-resolve{background:rgba(0,200,81,0.2);border:1px solid rgba(0,200,81,0.4);border-radius:7px;padding:5px 10px;color:var(--green);font-size:11px;font-weight:700;cursor:pointer;white-space:nowrap;}

/* â”€â”€ LOCATION GRID â”€â”€ */
.loc-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:9px;padding:0 14px 12px;}
.loc-btn{background:var(--card2);border:2px solid rgba(255,255,255,0.09);border-radius:12px;padding:14px 10px;cursor:pointer;text-align:center;transition:all 0.15s;}
.loc-btn:active{transform:scale(0.96);}
.loc-btn.selected{border-color:var(--yellow);background:rgba(255,214,0,0.1);}
.loc-btn.ar{border-color:var(--red);background:rgba(255,20,20,0.15);animation:borderRed 1s infinite;}
.loc-btn.ab{border-color:#888;background:rgba(100,100,100,0.15);}
@keyframes borderRed{0%,100%{box-shadow:0 0 0 0 rgba(255,20,20,0.6)}50%{box-shadow:0 0 0 8px rgba(255,20,20,0)}}
.loc-num{font-family:'Black Han Sans';font-size:26px;color:var(--yellow);}
.loc-name{font-size:12px;font-weight:700;margin-top:3px;}
.loc-st{font-size:10px;margin-top:4px;}

/* â”€â”€ ALERT BUTTONS â”€â”€ */
.alert-area{padding:0 14px 10px;}
.alert-row{display:grid;grid-template-columns:1fr 1fr;gap:10px;}
.abtn{border:none;border-radius:14px;padding:20px 10px;cursor:pointer;transition:all 0.15s;}
.abtn:active{transform:scale(0.95);}
.abtn-black{background:linear-gradient(135deg,#2a2b3d,#111);border:3px solid #4a4a5a;}
.abtn-red{background:linear-gradient(135deg,#8b0000,#500);border:3px solid var(--red);box-shadow:0 4px 24px rgba(255,20,20,0.45);}
.abtn .ai{font-size:34px;display:block;margin-bottom:6px;}
.abtn .al{font-family:'Black Han Sans';font-size:20px;letter-spacing:1px;}
.abtn .ad{font-size:10px;color:rgba(255,255,255,0.6);margin-top:5px;display:block;line-height:1.5;font-family:'Noto Sans KR';}
.abtn-red .ad{color:rgba(255,180,180,0.8);}

/* â”€â”€ MAP â”€â”€ */
#screen-map{background:var(--bg);}
.map-wrap{padding:12px;flex:1;overflow-y:auto;}
.map-frame{position:relative;border-radius:12px;overflow:hidden;border:2px solid rgba(255,255,255,0.08);background:#0a1520;margin-bottom:12px;}
.map-img{width:100%;display:block;opacity:0.88;}
.map-marker{position:absolute;transform:translate(-50%,-50%);cursor:pointer;z-index:10;}
.mdot{width:34px;height:34px;border-radius:50%;background:rgba(20,22,39,0.92);border:3px solid rgba(255,255,255,0.5);display:flex;align-items:center;justify-content:center;font-family:'Black Han Sans';font-size:13px;color:white;box-shadow:0 2px 10px rgba(0,0,0,0.6);transition:all 0.3s;}
.map-marker.mr .mdot{background:var(--red);border-color:#ff8888;animation:mkRed 0.7s infinite;box-shadow:0 0 30px rgba(255,20,20,1);}
.map-marker.mb .mdot{background:#333;border-color:#bbb;animation:mkBlack 1.2s infinite;}
@keyframes mkRed{0%,100%{box-shadow:0 0 0 0 rgba(255,20,20,0.9);transform:translate(-50%,-50%) scale(1)}50%{box-shadow:0 0 0 14px rgba(255,20,20,0);transform:translate(-50%,-50%) scale(1.12)}}
@keyframes mkBlack{0%,100%{box-shadow:0 0 0 0 rgba(200,200,200,0.7)}50%{box-shadow:0 0 0 10px rgba(200,200,200,0)}}
.mlbl{position:absolute;top:37px;left:50%;transform:translateX(-50%);background:rgba(0,0,0,0.85);color:white;font-size:9px;font-weight:700;white-space:nowrap;padding:2px 6px;border-radius:4px;pointer-events:none;}

.log-section{padding:0 12px 80px;}
.log-hdr{font-family:'Black Han Sans';font-size:13px;color:var(--muted);letter-spacing:2px;margin-bottom:8px;}
.log-item{background:var(--card);border-radius:10px;padding:11px 13px;margin-bottom:7px;border-left:4px solid #333;display:flex;align-items:center;gap:10px;animation:fadeIn 0.3s ease;}
@keyframes fadeIn{from{opacity:0;transform:translateY(4px)}to{opacity:1;transform:translateY(0)}}
.log-item.lr{border-left-color:var(--red);}
.log-item.lb{border-left-color:#666;}
.log-badge{font-family:'Black Han Sans';font-size:10px;padding:3px 7px;border-radius:5px;white-space:nowrap;}
.lr .log-badge{background:var(--red);color:white;}
.lb .log-badge{background:#555;color:white;}
.log-txt{flex:1;}
.log-loc{font-weight:700;font-size:13px;}
.log-who{font-size:10px;color:#777;margin-top:1px;}
.log-t{font-size:10px;color:#555;white-space:nowrap;}
.empty-log{text-align:center;color:#444;font-size:13px;padding:24px;}

/* â”€â”€ ADMIN â”€â”€ */
#screen-admin{background:var(--bg);overflow-y:auto;}
.adm-body{padding:12px;padding-bottom:80px;}
.adm-card{background:var(--card);border-radius:14px;padding:16px;margin-bottom:12px;border:1px solid rgba(255,255,255,0.06);}
.adm-card h3{font-family:'Black Han Sans';font-size:15px;color:var(--yellow);border-bottom:1px solid rgba(255,214,0,0.15);padding-bottom:8px;margin-bottom:14px;}

/* ì§ì›ë²ˆí˜¸ ê´€ë¦¬ */
.staff-row{display:flex;align-items:center;gap:8px;margin-bottom:8px;background:rgba(255,255,255,0.03);border-radius:8px;padding:8px 10px;}
.staff-num-badge{background:var(--red);min-width:44px;height:36px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-family:'Black Han Sans';font-size:16px;color:white;flex-shrink:0;}
.staff-edit-inp{flex:1;background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.12);border-radius:8px;padding:8px 10px;color:var(--white);font-family:'Noto Sans KR';font-size:13px;outline:none;}
.staff-edit-inp:focus{border-color:var(--yellow);}
.btn-del{background:rgba(255,20,20,0.2);border:1px solid rgba(255,20,20,0.3);border-radius:6px;padding:6px 10px;color:var(--red);font-size:12px;cursor:pointer;flex-shrink:0;}
.btn-add-row{display:flex;gap:8px;margin-top:8px;}
.inp-new-num{flex:0 0 80px;background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.12);border-radius:8px;padding:10px;color:var(--white);font-family:'Black Han Sans';font-size:16px;text-align:center;outline:none;}
.inp-new-num:focus{border-color:var(--yellow);}
.inp-new-name{flex:1;background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.12);border-radius:8px;padding:10px;color:var(--white);font-family:'Noto Sans KR';font-size:13px;outline:none;}
.inp-new-name:focus{border-color:var(--yellow);}
.btn-add{background:var(--green);border:none;border-radius:8px;padding:10px 14px;color:white;font-family:'Black Han Sans';font-size:14px;cursor:pointer;flex-shrink:0;}

/* ìœ„ì¹˜ ê´€ë¦¬ */
.loc-edit-row{display:flex;align-items:center;gap:8px;margin-bottom:8px;background:rgba(255,255,255,0.03);border-radius:8px;padding:8px 10px;}
.loc-num-badge{background:var(--blue);min-width:36px;height:36px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-family:'Black Han Sans';font-size:14px;color:var(--yellow);flex-shrink:0;}
.loc-inp{flex:1;background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.12);border-radius:8px;padding:8px 10px;color:var(--white);font-family:'Noto Sans KR';font-size:13px;outline:none;}
.loc-inp:focus{border-color:var(--yellow);}

.stat-row{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;}
.stat-box{background:var(--card2);border-radius:10px;padding:12px 8px;text-align:center;}
.stat-num{font-family:'Black Han Sans';font-size:26px;}
.stat-lbl{font-size:10px;color:var(--muted);margin-top:2px;}
.sr .stat-num{color:var(--red);} .sb .stat-num{color:#aaa;} .st .stat-num{color:#00C9B1;}

.test-row{display:grid;grid-template-columns:1fr 1fr;gap:8px;}
.btn-test{border:none;border-radius:10px;padding:13px;cursor:pointer;font-family:'Black Han Sans';font-size:14px;}

/* â”€â”€ BOTTOM NAV â”€â”€ */
.bnav{display:flex;background:rgba(8,9,20,0.97);border-top:2px solid rgba(255,255,255,0.07);padding:8px 0 max(8px, env(safe-area-inset-bottom));position:sticky;bottom:0;z-index:50;flex-shrink:0;}
.bnav-btn{flex:1;display:flex;flex-direction:column;align-items:center;gap:3px;background:none;border:none;color:var(--muted);font-family:'Noto Sans KR';font-size:10px;font-weight:700;cursor:pointer;padding:7px 4px;transition:color 0.2s;}
.bnav-btn .ni{font-size:21px;}
.bnav-btn.active{color:var(--yellow);}

/* â”€â”€ CONFIRM MODAL â”€â”€ */
#confirm-modal{display:none;position:fixed;inset:0;z-index:8000;background:rgba(0,0,0,0.88);align-items:center;justify-content:center;padding:24px;}
#confirm-modal.show{display:flex;}
.cm-box{background:var(--card2);border-radius:18px;padding:28px 22px;width:100%;max-width:320px;text-align:center;border:1px solid rgba(255,255,255,0.1);}
.cm-icon{font-size:50px;margin-bottom:12px;}
.cm-title{font-family:'Black Han Sans';font-size:22px;margin-bottom:8px;}
.cm-desc{font-size:13px;color:#bbb;line-height:1.7;margin-bottom:22px;white-space:pre-line;}
.cm-btns{display:grid;grid-template-columns:1fr 1fr;gap:10px;}
.cm-cancel{padding:14px;background:rgba(255,255,255,0.07);border:1px solid rgba(255,255,255,0.15);border-radius:10px;color:white;font-family:'Black Han Sans';font-size:15px;cursor:pointer;}
.cm-ok{padding:14px;border:none;border-radius:10px;color:white;font-family:'Black Han Sans';font-size:15px;cursor:pointer;}
.cm-ok.r{background:var(--red);} .cm-ok.b{background:#555;}

/* â”€â”€ ALERT OVERLAY â”€â”€ */
#alert-overlay{display:none;position:fixed;inset:0;z-index:9999;flex-direction:column;align-items:center;justify-content:center;text-align:center;padding:24px;}
#alert-overlay.show{display:flex;}
#alert-overlay.ov-red{background:rgba(160,0,0,0.97);animation:flashRed 0.35s 5;}
#alert-overlay.ov-black{background:rgba(15,15,15,0.98);}
@keyframes flashRed{0%,100%{background:rgba(160,0,0,0.97)}50%{background:rgba(255,40,40,1)}}
.ov-badge{font-family:'Black Han Sans';font-size:64px;letter-spacing:4px;animation:ovPulse 0.7s infinite;text-shadow:0 0 60px rgba(255,255,255,0.4);}
@keyframes ovPulse{0%,100%{transform:scale(1)}50%{transform:scale(1.06)}}
.ov-loc{font-family:'Black Han Sans';font-size:34px;color:var(--yellow);margin:8px 0 4px;}
.ov-time{font-size:13px;color:rgba(255,255,255,0.5);margin-bottom:4px;}
.ov-who{font-size:15px;color:rgba(255,255,255,0.8);margin-bottom:16px;}
.ov-desc{font-size:17px;line-height:1.7;margin-bottom:32px;max-width:300px;}
.ov-close{background:white;color:#111;border:none;border-radius:13px;padding:16px 44px;font-family:'Black Han Sans';font-size:20px;cursor:pointer;box-shadow:0 4px 24px rgba(0,0,0,0.5);letter-spacing:2px;}
.ov-note{font-size:11px;color:rgba(255,255,255,0.4);margin-top:14px;}

.divider{height:1px;background:rgba(255,255,255,0.06);margin:12px 0;}
</style>
</head>
<body>

<!-- â•â• SETUP â•â• -->
<div id="screen-setup" class="screen active">
  <div class="setup-card">
    <div class="setup-logo">
      <div class="emblem">ğŸš¨</div>
      <h1>ë¹„ìƒ í˜¸ì¶œ ì‹œìŠ¤í…œ</h1>
      <p>ì›Œí„°íŒŒí¬ ì•ˆì „ ê´€ë¦¬ì ì „ìš© Â· ì‹¤ì‹œê°„ ë™ê¸°í™”</p>
    </div>
    <div class="tabs">
      <button class="tab-btn active" onclick="switchSetupTab('login')">ğŸ‘¤ ë¡œê·¸ì¸</button>
      <button class="tab-btn" onclick="switchSetupTab('fb')">ğŸ”¥ Firebase</button>
    </div>

    <!-- LOGIN -->
    <div class="pane active" id="pane-login">
      <div class="field">
        <label>ì§ì› ë²ˆí˜¸</label>
        <div class="num-input-wrap">
          <input id="inp-num" type="number" inputmode="numeric" placeholder="ì˜ˆ) 101" autocomplete="off">
        </div>
        <div class="num-input-hint">ê´€ë¦¬ìê°€ ì§€ì •í•œ ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”</div>
      </div>
      <div class="field">
        <label>ë‹´ë‹¹ êµ¬ì—­</label>
        <select id="inp-zone"><option value="">-- êµ¬ì—­ ì„ íƒ --</option></select>
      </div>
      <button class="btn-main btn-red" onclick="doLogin()">ì…ì¥í•˜ê¸° â†’</button>
    </div>

    <!-- FIREBASE CONFIG -->
    <div class="pane" id="pane-fb">
      <div class="fb-hint">
        ğŸ“Œ <strong>Firebase ì„¤ì • ë°©ë²•</strong><br>
        1. <a href="https://console.firebase.google.com" target="_blank">Firebase ì½˜ì†”</a> â†’ í”„ë¡œì íŠ¸ ì„ íƒ<br>
        2. <strong>ë¹Œë“œ â†’ Realtime Database</strong> í™œì„±í™”<br>
        3. í”„ë¡œì íŠ¸ ì„¤ì • â†’ ì›¹ì•±(&#60;/&#62;) â†’ <strong>êµ¬ì„±</strong> ì„ íƒ<br>
        4. ì¤‘ê´„í˜¸ { } ì•ˆ ë‚´ìš©ë§Œ ë³µì‚¬ ë¶™ì—¬ë„£ê¸°
      </div>
      <div class="field">
        <label>Firebase Config (JSON)</label>
        <textarea id="inp-fb" placeholder='{"apiKey":"...","authDomain":"...","databaseURL":"https://...","projectId":"...","appId":"..."}'></textarea>
      </div>
      <button class="btn-main btn-green" onclick="saveFbAndReload()">ğŸ”¥ ì €ì¥ í›„ ì ìš©</button>
    </div>
  </div>
</div>

<!-- â•â• MAIN â•â• -->
<div id="screen-main" class="screen">
  <div class="hdr">
    <div class="hdr-logo">ğŸš¨ ë¹„ìƒ í˜¸ì¶œ</div>
    <span id="conn-status" style="color:#ff4444">ğŸ”´ ì—°ê²° ì¤‘...</span>
  </div>
  <div class="ubar">
    <div style="display:flex;align-items:center;gap:8px;">
      <span class="num-pill" id="disp-num">No.?</span>
      <span id="disp-zone" style="font-size:12px;color:#aaa;">êµ¬ì—­</span>
    </div>
    <button style="background:none;border:none;color:var(--muted);font-size:11px;cursor:pointer;" onclick="doLogout()">ë¡œê·¸ì•„ì›ƒ</button>
  </div>
  <div class="scroll-body">
    <div id="active-banner"></div>
    <div class="sec-label">ğŸ“ ë°œìƒ ìœ„ì¹˜ ì„ íƒ</div>
    <div class="loc-grid" id="loc-grid"></div>
    <div class="sec-label">âš¡ ìƒí™© ìœ í˜•</div>
    <div class="alert-area">
      <div class="alert-row">
        <button class="abtn abtn-black" onclick="openConfirm('black')">
          <span class="ai">ğŸ¦º</span><span class="al">ë¸”ë™ ìƒí™©</span>
          <span class="ad">ì˜ì‹ ìˆìŒ<br>ê³¨ì ˆÂ·íƒ€ë°•Â·ë¶€ìƒ</span>
        </button>
        <button class="abtn abtn-red" onclick="openConfirm('red')">
          <span class="ai">ğŸ’”</span><span class="al">ë ˆë“œ ìƒí™©</span>
          <span class="ad">ì˜ì‹ ì—†ìŒ<br>ìµìˆ˜Â·ì‹¬ì •ì§€ ì¦‰ê°ì‘ê¸‰</span>
        </button>
      </div>
    </div>
    <div style="text-align:center;font-size:11px;color:#444;padding:8px 0 16px;">* ë°œì†¡ ì‹œ ëª¨ë“  ê·¼ë¬´ì ê¸°ê¸°ì— ê²½ë³´ìŒ+ì§„ë™ ì „íŒŒ</div>
  </div>
  <div class="bnav">
    <button class="bnav-btn active" onclick="showTab('main')"><span class="ni">ğŸš¨</span>í˜¸ì¶œ</button>
    <button class="bnav-btn"        onclick="showTab('map')"><span class="ni">ğŸ—ºï¸</span>ì§€ë„</button>
    <button class="bnav-btn"        onclick="showTab('admin')"><span class="ni">âš™ï¸</span>ê´€ë¦¬ì</button>
  </div>
</div>

<!-- â•â• MAP â•â• -->
<div id="screen-map" class="screen">
  <div class="hdr">
    <div class="hdr-logo">ğŸ—ºï¸ ìœ„ì¹˜ í˜„í™©</div>
    <span style="font-size:11px;color:var(--green)">ì‹¤ì‹œê°„</span>
  </div>
  <div class="map-wrap">
    <div class="map-frame" id="map-frame">
      <div id="map-placeholder" style="height:160px;display:flex;align-items:center;justify-content:center;color:#555;font-size:13px;">ì§€ë„ ì´ë¯¸ì§€ ì—†ìŒ</div>
    </div>
    <div class="log-section">
      <div class="log-hdr">ğŸ“‹ ìµœê·¼ ì•Œë¦¼ ê¸°ë¡</div>
      <div id="log-list"><div class="empty-log">ì•„ì§ ë°œìƒí•œ ìƒí™©ì´ ì—†ìŠµë‹ˆë‹¤</div></div>
    </div>
  </div>
  <div class="bnav">
    <button class="bnav-btn"        onclick="showTab('main')"><span class="ni">ğŸš¨</span>í˜¸ì¶œ</button>
    <button class="bnav-btn active" onclick="showTab('map')"><span class="ni">ğŸ—ºï¸</span>ì§€ë„</button>
    <button class="bnav-btn"        onclick="showTab('admin')"><span class="ni">âš™ï¸</span>ê´€ë¦¬ì</button>
  </div>
</div>

<!-- â•â• ADMIN â•â• -->
<div id="screen-admin" class="screen">
  <div class="hdr"><div class="hdr-logo">âš™ï¸ ê´€ë¦¬ì ì„¤ì •</div></div>
  <div class="adm-body">

    <!-- ì§ì› ë²ˆí˜¸ ê´€ë¦¬ -->
    <div class="adm-card">
      <h3>ğŸ‘¤ ì§ì› ë²ˆí˜¸ ê´€ë¦¬</h3>
      <div id="staff-list"></div>
      <div class="divider"></div>
      <div style="font-size:11px;color:var(--muted);margin-bottom:8px;">ìƒˆ ì§ì› ë²ˆí˜¸ ì¶”ê°€</div>
      <div class="btn-add-row">
        <input class="inp-new-num" id="new-staff-num" type="number" inputmode="numeric" placeholder="ë²ˆí˜¸">
        <input class="inp-new-name" id="new-staff-name" type="text" placeholder="ì§ì±…/ì´ë¦„ (ì˜ˆ: ì•ˆì „ìš”ì›1)">
        <button class="btn-add" onclick="addStaff()">ì¶”ê°€</button>
      </div>
      <button class="btn-main btn-blue" style="font-size:15px;padding:12px;margin-top:12px;" onclick="saveStaff()">ğŸ’¾ ì§ì› ëª©ë¡ ì €ì¥</button>
    </div>

    <!-- ìœ„ì¹˜ ê´€ë¦¬ -->
    <div class="adm-card">
      <h3>ğŸ“ ìœ„ì¹˜ ê´€ë¦¬</h3>
      <div id="loc-edit-list"></div>
      <div class="divider"></div>
      <div style="font-size:11px;color:var(--muted);margin-bottom:8px;">ìƒˆ ìœ„ì¹˜ ì¶”ê°€</div>
      <div class="btn-add-row">
        <input class="inp-new-num" id="new-loc-num" type="number" inputmode="numeric" placeholder="ë²ˆí˜¸">
        <input class="inp-new-name" id="new-loc-name" type="text" placeholder="ìœ„ì¹˜ ì´ë¦„ (ì˜ˆ: í‚¤ì¦ˆí’€)">
        <button class="btn-add" onclick="addLocation()">ì¶”ê°€</button>
      </div>
      <button class="btn-main btn-blue" style="font-size:15px;padding:12px;margin-top:12px;" onclick="saveLocations()">ğŸ’¾ ìœ„ì¹˜ ëª©ë¡ ì €ì¥ (ì „ì²´ ë™ê¸°í™”)</button>
    </div>

    <!-- í†µê³„ -->
    <div class="adm-card">
      <h3>ğŸ“Š ìƒí™© í†µê³„</h3>
      <div class="stat-row">
        <div class="stat-box sr"><div class="stat-num" id="stat-r">0</div><div class="stat-lbl">ë ˆë“œ</div></div>
        <div class="stat-box sb"><div class="stat-num" id="stat-b">0</div><div class="stat-lbl">ë¸”ë™</div></div>
        <div class="stat-box st"><div class="stat-num" id="stat-t">0</div><div class="stat-lbl">ì „ì²´</div></div>
      </div>
    </div>

    <!-- ê²½ë³´ í…ŒìŠ¤íŠ¸ -->
    <div class="adm-card">
      <h3>ğŸ”” ê²½ë³´ í…ŒìŠ¤íŠ¸</h3>
      <div class="test-row">
        <button class="btn-test" style="background:#333;color:white;" onclick="testAlert('black')">ğŸ¦º ë¸”ë™ í…ŒìŠ¤íŠ¸</button>
        <button class="btn-test" style="background:var(--red);color:white;" onclick="testAlert('red')">ğŸ’” ë ˆë“œ í…ŒìŠ¤íŠ¸</button>
      </div>
    </div>

    <!-- Firebase ì¬ì„¤ì • -->
    <div class="adm-card">
      <h3>ğŸ”¥ Firebase ì¬ì„¤ì •</h3>
      <div class="field">
        <label>Firebase Config (JSON)</label>
        <textarea id="adm-fb" placeholder='{"apiKey":"...","databaseURL":"..."}'></textarea>
      </div>
      <button class="btn-main btn-green" style="font-size:15px;padding:12px;" onclick="adminSaveFb()">ì €ì¥ í›„ ì¬ì ìš©</button>
    </div>

    <button class="btn-main btn-danger" style="font-size:16px;padding:12px;" onclick="doLogout()">ğŸšª ë¡œê·¸ì•„ì›ƒ</button>
  </div>
  <div class="bnav">
    <button class="bnav-btn"        onclick="showTab('main')"><span class="ni">ğŸš¨</span>í˜¸ì¶œ</button>
    <button class="bnav-btn"        onclick="showTab('map')"><span class="ni">ğŸ—ºï¸</span>ì§€ë„</button>
    <button class="bnav-btn active" onclick="showTab('admin')"><span class="ni">âš™ï¸</span>ê´€ë¦¬ì</button>
  </div>
</div>

<!-- â”€â”€ PIN ëª¨ë‹¬ (ê´€ë¦¬ì ì¸ì¦) â”€â”€ -->
<div id="pin-modal">
  <div class="pin-box">
    <h3>ğŸ” ê´€ë¦¬ì ì¸ì¦</h3>
    <p>ê´€ë¦¬ì PINì„ ì…ë ¥í•˜ì„¸ìš”</p>
    <input class="pin-input" id="pin-input" type="password" inputmode="numeric" maxlength="6" placeholder="â€¢â€¢â€¢â€¢">
    <div class="pin-btns">
      <button class="pin-cancel" onclick="closePinModal()">ì·¨ì†Œ</button>
      <button class="pin-ok" onclick="confirmPin()">í™•ì¸</button>
    </div>
  </div>
</div>

<!-- â”€â”€ CONFIRM â”€â”€ -->
<div id="confirm-modal">
  <div class="cm-box">
    <div class="cm-icon" id="cm-icon">âš ï¸</div>
    <div class="cm-title" id="cm-title">í™•ì¸</div>
    <div class="cm-desc" id="cm-desc"></div>
    <div class="cm-btns">
      <button class="cm-cancel" onclick="closeConfirm()">ì·¨ì†Œ</button>
      <button class="cm-ok" id="cm-ok" onclick="doSend()">ë°œì†¡</button>
    </div>
  </div>
</div>

<!-- â”€â”€ OVERLAY â”€â”€ -->
<div id="alert-overlay">
  <div class="ov-badge" id="ov-badge"></div>
  <div class="ov-loc"   id="ov-loc"></div>
  <div class="ov-time"  id="ov-time"></div>
  <div class="ov-who"   id="ov-who"></div>
  <div class="ov-desc"  id="ov-desc"></div>
  <button class="ov-close" onclick="closeOverlay()">âœ… í™•ì¸ / ì¶œë™</button>
  <div class="ov-note"  id="ov-note"></div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ë°ì´í„°
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let locations = [
  {id:1,name:'íŒŒë„í’€',   px:34,py:45},
  {id:2,name:'ìˆ˜ì˜ì¥',   px:14,py:40},
  {id:3,name:'ìœ ìˆ˜1ë²ˆ',  px:42,py:58},
  {id:4,name:'ë°”ë°í’€',   px:74,py:50},
  {id:5,name:'ë‚¨ìì‚¬ìš°ë‚˜',px:60,py:65},
  {id:6,name:'ì—¬ìì‚¬ìš°ë‚˜',px:57,py:25},
  {id:7,name:'ì¨ë‹ˆíŒŒí¬', px:50,py:85},
];

// ì§ì› ë²ˆí˜¸ ëª©ë¡: [{num:'101', label:'ì•ˆì „ìš”ì›1'}, ...]
let staffList = [
  {num:'101', label:'ì•ˆì „ìš”ì›1'},
  {num:'102', label:'ì•ˆì „ìš”ì›2'},
  {num:'103', label:'ì•ˆì „ìš”ì›3'},
  {num:'201', label:'ì˜ë£Œì§„1'},
  {num:'999', label:'ê´€ë¦¬ì'},
];

const ADMIN_PIN = '1234'; // â† ê´€ë¦¬ì PIN (í•„ìš”ì‹œ ë³€ê²½)

let currentUser = {num:'', zone:''};
let pending = {type:null, locId:null};
let activeAlerts = {};
let alertLog = [];
let statsR=0, statsB=0;
let selectedLocId = null;
let DB = null, fbReady = false;
let pinCallback = null; // PIN í™•ì¸ í›„ ì‹¤í–‰í•  í•¨ìˆ˜

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  AUDIO / VIBRATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let audioCtx = null;
function getCtx() {
  if (!audioCtx) audioCtx = new (window.AudioContext||window.webkitAudioContext)();
  return audioCtx;
}
function playAlert(type) {
  try {
    const ctx = getCtx();
    const seq = type==='red'
      ? [{f:1400,d:220},{f:900,d:220},{f:1400,d:220},{f:900,d:220},{f:1400,d:300},{f:900,d:300}]
      : [{f:750,d:380},{f:750,d:380},{f:750,d:380}];
    let t = ctx.currentTime;
    seq.forEach(({f,d}) => {
      const o=ctx.createOscillator(), g=ctx.createGain();
      o.connect(g); g.connect(ctx.destination);
      o.frequency.value=f; o.type=type==='red'?'square':'sine';
      g.gain.setValueAtTime(0.5,t);
      g.gain.exponentialRampToValueAtTime(0.001,t+d/1000);
      o.start(t); o.stop(t+d/1000); t+=d/1000+0.06;
    });
  } catch(e){}
}
function vib(type) {
  try { if('vibrate'in navigator) navigator.vibrate(type==='red'?[300,80,300,80,300,80,600]:[200,100,200,100,200]); } catch(e){}
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  FIREBASE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function initFirebase() {
  const saved = localStorage.getItem('wp_fb_config');
  if (!saved) { setConn(false,'ğŸ”´ Firebase ë¯¸ì„¤ì •'); return; }
  let cfg;
  try { cfg=JSON.parse(saved); } catch(e) { setConn(false,'ğŸ”´ ì„¤ì • ì˜¤ë¥˜'); return; }
  if (!cfg.databaseURL) { setConn(false,'ğŸ”´ databaseURL ì—†ìŒ'); return; }
  try {
    const {initializeApp,getApps,getApp} = await import('https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js');
    const {getDatabase,ref,set,push,onValue,remove,serverTimestamp}
      = await import('https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js');

    const app = getApps().length>0 ? getApp() : initializeApp(cfg);
    DB = getDatabase(app);
    fbReady = true;
    setConn(true,'ğŸŸ¢ ì‹¤ì‹œê°„ ì—°ê²°ë¨');

    window._fbSend = async function(payload) {
      const r = ref(DB,'alerts');
      await push(r,{...payload,ts:serverTimestamp()});
      await set(ref(DB,`activeAlerts/${payload.locId}`),{
        type:payload.type, locName:payload.locName, reporter:payload.reporter, ts:serverTimestamp()
      });
    };
    window._fbResolve = async function(locId) { await remove(ref(DB,`activeAlerts/${locId}`)); };
    window._fbSaveLocs = async function(locs) { await set(ref(DB,'locations'),locs); };
    window._fbSaveStaff = async function(staff) { await set(ref(DB,'staffList'),staff); };

    // ë¦¬ìŠ¤ë„ˆ 1: activeAlerts
    onValue(ref(DB,'activeAlerts'),(snap) => {
      activeAlerts = snap.val()||{};
      updateBanner(); buildLocGrid(); rebuildMarkers();
    });

    // ë¦¬ìŠ¤ë„ˆ 2: alerts â€” ë¡œê·¸ì¸ ì‹œê°„ ì´í›„ ìƒˆ ì•Œë¦¼ë§Œ ê²½ë³´
    const loginTime = Date.now();
    onValue(ref(DB,'alerts'),(snap) => {
      const data = snap.val();
      if (!data) return;
      const entries = Object.entries(data);
      const [,latest] = entries[entries.length-1];
      const alertTime = latest.clientTime||0;
      if (alertTime <= loginTime) return;
      playAlert(latest.type);
      vib(latest.type);
      if (latest.reporter !== currentUser.num) {
        showOverlay(latest.type, latest.locName, latest.time, latest.reporter, false);
      }
      appendLog(latest);
    });

    // ë¦¬ìŠ¤ë„ˆ 3: locations
    onValue(ref(DB,'locations'),(snap) => {
      const d = snap.val();
      if (d && Array.isArray(d)) {
        locations = d;
        buildLocGrid(); rebuildMarkers(); rebuildLocEditList(); rebuildZoneSelect();
      }
    });

    // ë¦¬ìŠ¤ë„ˆ 4: staffList
    onValue(ref(DB,'staffList'),(snap) => {
      const d = snap.val();
      if (d && Array.isArray(d)) {
        staffList = d;
        rebuildStaffList();
      }
    });

  } catch(e) {
    console.error('[Firebase]',e);
    setConn(false,'ğŸ”´ ì—°ê²° ì‹¤íŒ¨');
  }
}

function setConn(ok, msg) {
  fbReady=ok;
  const el=document.getElementById('conn-status');
  if(el){el.textContent=msg;el.style.color=ok?'#00C851':'#ff4444';}
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  PIN ê´€ë¦¬ì ì¸ì¦
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function requirePin(callback) {
  pinCallback = callback;
  document.getElementById('pin-input').value='';
  document.getElementById('pin-modal').classList.add('show');
  setTimeout(()=>document.getElementById('pin-input').focus(),200);
}
function closePinModal() {
  document.getElementById('pin-modal').classList.remove('show');
  pinCallback = null;
}
function confirmPin() {
  const entered = document.getElementById('pin-input').value;
  if (entered === ADMIN_PIN) {
    closePinModal();
    if (pinCallback) pinCallback();
  } else {
    document.getElementById('pin-input').value='';
    document.getElementById('pin-input').placeholder='âŒ í‹€ë ¸ìŠµë‹ˆë‹¤';
    setTimeout(()=>{ document.getElementById('pin-input').placeholder='â€¢â€¢â€¢â€¢'; },1500);
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SEND ALERT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openConfirm(type) {
  if (!selectedLocId) { alert('ë¨¼ì € ìœ„ì¹˜ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”!'); return; }
  pending = {type, locId:selectedLocId};
  const loc = locations.find(l=>l.id===selectedLocId);
  const locName = `${loc.id}ë²ˆ ${loc.name}`;
  const isRed = type==='red';
  document.getElementById('cm-icon').textContent = isRed?'ğŸ’”':'ğŸ¦º';
  document.getElementById('cm-title').textContent = isRed?'ë ˆë“œ ìƒí™© ë°œì†¡':'ë¸”ë™ ìƒí™© ë°œì†¡';
  document.getElementById('cm-title').style.color = isRed?'#ff4444':'#aaa';
  document.getElementById('cm-desc').textContent =
    `${locName}\n${isRed?'ì˜ì‹ ì—†ìŒ / ìµìˆ˜Â·ì‹¬ì •ì§€ ì‘ê¸‰':'ì˜ì‹ ìˆìŒ / ë¶€ìƒÂ·ê³¨ì ˆ ì‘ê¸‰'}\n\nì „ ì§ì› ê¸°ê¸°ì— ì¦‰ì‹œ ì „íŒŒë©ë‹ˆë‹¤.`;
  document.getElementById('cm-ok').className=`cm-ok ${isRed?'r':'b'}`;
  document.getElementById('confirm-modal').classList.add('show');
}
function closeConfirm() { document.getElementById('confirm-modal').classList.remove('show'); }

async function doSend() {
  closeConfirm();
  const {type,locId}=pending;
  if (!type||!locId) return;
  const loc=locations.find(l=>l.id===locId);
  const locName=`${loc.id}ë²ˆ ${loc.name}`;
  const timeStr=new Date().toLocaleTimeString('ko-KR');
  const payload={type,locId,locName,reporter:currentUser.num,time:timeStr,clientTime:Date.now()};

  playAlert(type); vib(type);
  showOverlay(type,locName,timeStr,`No.${currentUser.num}`,true);

  if (fbReady&&window._fbSend) {
    try { await window._fbSend(payload); } catch(e) { offlineFallback(payload); }
  } else { offlineFallback(payload); }
}

function offlineFallback(payload) {
  activeAlerts[payload.locId]={type:payload.type,locName:payload.locName,reporter:payload.reporter};
  localStorage.setItem('wp_active',JSON.stringify(activeAlerts));
  appendLog(payload); updateBanner(); buildLocGrid(); rebuildMarkers();
}

async function resolveAlert(locId) {
  if (!confirm('ìƒí™©ì´ í•´ê²°ë˜ì—ˆìŠµë‹ˆê¹Œ?')) return;
  if (fbReady&&window._fbResolve) try{await window._fbResolve(locId);}catch(e){}
  delete activeAlerts[locId];
  localStorage.setItem('wp_active',JSON.stringify(activeAlerts));
  updateBanner(); buildLocGrid(); rebuildMarkers();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  OVERLAY
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showOverlay(type,locName,timeStr,reporter,isSelf) {
  const ov=document.getElementById('alert-overlay');
  document.getElementById('ov-badge').textContent=type==='red'?'ğŸš¨ ë ˆë“œ ìƒí™© ğŸš¨':'âš ï¸ ë¸”ë™ ìƒí™© âš ï¸';
  document.getElementById('ov-loc').textContent=locName;
  document.getElementById('ov-time').textContent=timeStr;
  document.getElementById('ov-who').textContent=`ë°œì†¡: ${reporter}`;
  document.getElementById('ov-desc').textContent=type==='red'
    ?'ì˜ì‹ ì—†ìŒ / ì¦‰ì‹œ ì‘ê¸‰ì²˜ì¹˜ í•„ìš”\ní•´ë‹¹ ìœ„ì¹˜ë¡œ ì¦‰ì‹œ ì´ë™í•˜ì‹­ì‹œì˜¤!'
    :'ì˜ì‹ ìˆìŒ / ë¶€ìƒ ì‘ê¸‰ì²˜ì¹˜ í•„ìš”\ní•´ë‹¹ ìœ„ì¹˜ë¡œ ì´ë™í•˜ì‹­ì‹œì˜¤.';
  document.getElementById('ov-note').textContent=isSelf?'':'ğŸ“¡ ë‹¤ë¥¸ ê·¼ë¬´ìì˜ í˜¸ì¶œì…ë‹ˆë‹¤';
  ov.className=`show ov-${type}`; ov.style.display='flex';
}
function closeOverlay() { const ov=document.getElementById('alert-overlay'); ov.style.display='none'; ov.className=''; }
function testAlert(type) {
  playAlert(type); vib(type);
  showOverlay(type,`${locations[0].id}ë²ˆ ${locations[0].name}`,new Date().toLocaleTimeString('ko-KR'),'í…ŒìŠ¤íŠ¸',true);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  UI: ìœ„ì¹˜ ê·¸ë¦¬ë“œ
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function buildLocGrid() {
  const g=document.getElementById('loc-grid');
  g.innerHTML='';
  locations.forEach(l=>{
    const a=activeAlerts[l.id];
    const btn=document.createElement('button');
    btn.className='loc-btn'+(selectedLocId===l.id?' selected':'')+(a?` a${a.type[0]}`:'');
    btn.innerHTML=`<div class="loc-num">${l.id}ë²ˆ</div><div class="loc-name">${l.name}</div>`
      +(a?`<div class="loc-st" style="color:${a.type==='red'?'#ff6666':'#aaa'}">${a.type==='red'?'ğŸ”´ ë ˆë“œ':'âš« ë¸”ë™'} ì§„í–‰ì¤‘</div>`:'');
    btn.onclick=()=>{selectedLocId=l.id;pending.locId=l.id;buildLocGrid();};
    g.appendChild(btn);
  });
}

function updateBanner() {
  const el=document.getElementById('active-banner');
  const keys=Object.keys(activeAlerts);
  if(!keys.length){el.innerHTML='';return;}
  el.innerHTML=keys.map(k=>{
    const a=activeAlerts[k];
    return `<div class="banner-item b${a.type[0]}">
      <span class="btype">${a.type==='red'?'ğŸ”´ ë ˆë“œ':'âš« ë¸”ë™'}</span>
      <div class="binfo"><div class="bloc">${a.locName}</div><div class="bsub">ë°œì†¡: No.${a.reporter||'?'}</div></div>
      <button class="btn-resolve" onclick="resolveAlert(${k})">í•´ê²° âœ“</button>
    </div>`;
  }).join('');
}

function rebuildMarkers() {
  const frame=document.getElementById('map-frame');
  frame.querySelectorAll('.map-marker').forEach(m=>m.remove());
  locations.forEach(l=>{
    const m=document.createElement('div');
    m.className='map-marker'+(activeAlerts[l.id]?` m${activeAlerts[l.id].type[0]}`:'');
    m.style.left=l.px+'%'; m.style.top=l.py+'%';
    m.innerHTML=`<div class="mdot">${l.id}</div><div class="mlbl">${l.name}</div>`;
    m.onclick=()=>{selectedLocId=l.id;pending.locId=l.id;buildLocGrid();showTab('main');};
    frame.appendChild(m);
  });
}

function appendLog(entry) {
  if(alertLog.length&&alertLog[0].time===entry.time&&alertLog[0].locName===entry.locName) return;
  alertLog.unshift(entry);
  if(alertLog.length>60) alertLog=alertLog.slice(0,60);
  localStorage.setItem('wp_log',JSON.stringify(alertLog));
  if(entry.type==='red') statsR++; else statsB++;
  localStorage.setItem('wp_stats',JSON.stringify({r:statsR,b:statsB}));
  renderLog(); updateStats();
}
function renderLog() {
  const el=document.getElementById('log-list');
  if(!alertLog.length){el.innerHTML='<div class="empty-log">ì•„ì§ ë°œìƒí•œ ìƒí™©ì´ ì—†ìŠµë‹ˆë‹¤</div>';return;}
  el.innerHTML=alertLog.slice(0,15).map(e=>`
    <div class="log-item l${e.type[0]}">
      <span class="log-badge">${e.type==='red'?'ğŸ”´ ë ˆë“œ':'âš« ë¸”ë™'}</span>
      <div class="log-txt"><div class="log-loc">${e.locName}</div><div class="log-who">No.${e.reporter||'?'}</div></div>
      <div class="log-t">${e.time||''}</div>
    </div>`).join('');
}
function updateStats() {
  document.getElementById('stat-r').textContent=statsR;
  document.getElementById('stat-b').textContent=statsB;
  document.getElementById('stat-t').textContent=statsR+statsB;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  UI: ì§ì› ë²ˆí˜¸ ê´€ë¦¬
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function rebuildStaffList() {
  const el=document.getElementById('staff-list');
  if(!el) return;
  el.innerHTML = staffList.map((s,i)=>`
    <div class="staff-row">
      <div class="staff-num-badge">${s.num}</div>
      <input class="staff-edit-inp" id="sn-${i}" value="${s.label}" placeholder="ì§ì±…/ì´ë¦„">
      <input class="staff-edit-inp" id="snnum-${i}" value="${s.num}" placeholder="ë²ˆí˜¸" style="max-width:70px;text-align:center;font-family:'Black Han Sans';">
      <button class="btn-del" onclick="deleteStaff(${i})">ì‚­ì œ</button>
    </div>`).join('');
}

function addStaff() {
  const num=document.getElementById('new-staff-num').value.trim();
  const label=document.getElementById('new-staff-name').value.trim();
  if (!num) { alert('ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”'); return; }
  if (staffList.find(s=>s.num===num)) { alert('ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ë²ˆí˜¸ì…ë‹ˆë‹¤'); return; }
  staffList.push({num, label:label||`ì§ì›${num}`});
  document.getElementById('new-staff-num').value='';
  document.getElementById('new-staff-name').value='';
  rebuildStaffList();
}
function deleteStaff(idx) {
  if (!confirm(`${staffList[idx].num}ë²ˆì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
  staffList.splice(idx,1);
  rebuildStaffList();
}
async function saveStaff() {
  // ìˆ˜ì •ëœ ê°’ ë°˜ì˜
  staffList.forEach((s,i)=>{
    const lbl=document.getElementById(`sn-${i}`);
    const num=document.getElementById(`snnum-${i}`);
    if(lbl) s.label=lbl.value;
    if(num) s.num=num.value;
  });
  localStorage.setItem('wp_staff',JSON.stringify(staffList));
  if(fbReady&&window._fbSaveStaff) try{await window._fbSaveStaff(staffList);}catch(e){}
  rebuildStaffList();
  rebuildZoneSelect(); // ì§ì› ëª©ë¡ ì—…ë°ì´íŠ¸
  alert('ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  UI: ìœ„ì¹˜ ê´€ë¦¬
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function rebuildLocEditList() {
  const el=document.getElementById('loc-edit-list');
  if(!el) return;
  el.innerHTML = locations.map((l,i)=>`
    <div class="loc-edit-row">
      <div class="loc-num-badge">${l.id}</div>
      <input class="loc-inp" id="ln-${i}" value="${l.name}" placeholder="ìœ„ì¹˜ ì´ë¦„">
      <input class="loc-inp" id="lnid-${i}" value="${l.id}" placeholder="ë²ˆí˜¸" style="max-width:60px;text-align:center;font-family:'Black Han Sans';">
      <button class="btn-del" onclick="deleteLocation(${i})">ì‚­ì œ</button>
    </div>`).join('');
}

function addLocation() {
  const num=parseInt(document.getElementById('new-loc-num').value.trim());
  const name=document.getElementById('new-loc-name').value.trim();
  if (!num) { alert('ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”'); return; }
  if (!name) { alert('ìœ„ì¹˜ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”'); return; }
  if (locations.find(l=>l.id===num)) { alert('ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ë²ˆí˜¸ì…ë‹ˆë‹¤'); return; }
  // ì§€ë„ìƒ ìœ„ì¹˜ëŠ” ì¤‘ì•™ì— ë°°ì¹˜ (ë‚˜ì¤‘ì— ê´€ë¦¬ìê°€ ì¡°ì • ê°€ëŠ¥)
  locations.push({id:num, name, px:50, py:50});
  locations.sort((a,b)=>a.id-b.id);
  document.getElementById('new-loc-num').value='';
  document.getElementById('new-loc-name').value='';
  rebuildLocEditList();
  buildLocGrid();
  rebuildZoneSelect();
}

function deleteLocation(idx) {
  if (!confirm(`"${locations[idx].name}"ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
  locations.splice(idx,1);
  rebuildLocEditList(); buildLocGrid(); rebuildMarkers(); rebuildZoneSelect();
}

async function saveLocations() {
  // ìˆ˜ì •ëœ ê°’ ë°˜ì˜
  locations.forEach((l,i)=>{
    const nm=document.getElementById(`ln-${i}`);
    const id=document.getElementById(`lnid-${i}`);
    if(nm) l.name=nm.value;
    if(id) l.id=parseInt(id.value)||l.id;
  });
  locations.sort((a,b)=>a.id-b.id);
  localStorage.setItem('wp_locs',JSON.stringify(locations));
  if(fbReady&&window._fbSaveLocs) try{await window._fbSaveLocs(locations);}catch(e){}
  rebuildLocEditList(); buildLocGrid(); rebuildMarkers(); rebuildZoneSelect();
  alert('ìœ„ì¹˜ ëª©ë¡ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!');
}

function rebuildZoneSelect() {
  const sel=document.getElementById('inp-zone');
  if(!sel) return;
  const prev=sel.value;
  while(sel.options.length>1) sel.remove(1);
  locations.forEach(l=>{
    const o=document.createElement('option');
    o.value=`${l.id}ë²ˆ ${l.name}`; o.textContent=o.value;
    sel.appendChild(o);
  });
  if(prev) sel.value=prev;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  NAV / LOGIN
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showTab(tab) {
  // ê´€ë¦¬ì íƒ­ì€ PIN ì¸ì¦ í•„ìš”
  if (tab==='admin') {
    requirePin(()=>_showTab('admin'));
    return;
  }
  _showTab(tab);
}
function _showTab(tab) {
  ['main','map','admin'].forEach(t=>{
    const s=document.getElementById(`screen-${t}`);
    s.classList.remove('active');
    s.querySelectorAll('.bnav-btn').forEach((b,i)=>{
      b.classList.toggle('active',['main','map','admin'][i]===tab);
    });
  });
  document.getElementById(`screen-${tab}`).classList.add('active');
  if(tab==='map'){rebuildMarkers();renderLog();}
  if(tab==='admin'){rebuildLocEditList();rebuildStaffList();updateStats();}
}

function switchSetupTab(tab) {
  document.querySelectorAll('.tab-btn').forEach((b,i)=>b.classList.toggle('active',['login','fb'][i]===tab));
  document.querySelectorAll('.pane').forEach((p,i)=>p.classList.toggle('active',['pane-login','pane-fb'][i]===`pane-${tab}`));
}

function doLogin() {
  const num=document.getElementById('inp-num').value.trim();
  const zone=document.getElementById('inp-zone').value;
  if (!num) { alert('ì§ì› ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”'); return; }
  if (!zone) { alert('ë‹´ë‹¹ êµ¬ì—­ì„ ì„ íƒí•˜ì„¸ìš”'); return; }
  // ì§ì› ë²ˆí˜¸ ìœ íš¨ì„± ê²€ì‚¬
  const found = staffList.find(s=>s.num===num);
  if (!found) {
    if (!confirm(`ë“±ë¡ë˜ì§€ ì•Šì€ ë²ˆí˜¸ì…ë‹ˆë‹¤ (${num}ë²ˆ).\nê³„ì† ì…ì¥í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
  }
  currentUser={num, zone};
  document.getElementById('disp-num').textContent=`No.${num}`;
  document.getElementById('disp-zone').textContent=zone;
  document.getElementById('screen-setup').classList.remove('active');
  document.getElementById('screen-main').classList.add('active');
}

function doLogout() {
  if(!confirm('ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
  ['main','map','admin'].forEach(t=>document.getElementById(`screen-${t}`).classList.remove('active'));
  document.getElementById('screen-setup').classList.add('active');
  switchSetupTab('login');
}

function saveFbAndReload() {
  const v=document.getElementById('inp-fb').value.trim();
  if(!v){alert('ì„¤ì •ê°’ì„ ì…ë ¥í•´ì£¼ì„¸ìš”');return;}
  try{JSON.parse(v);}catch(e){alert('JSON í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤\nì¤‘ê´„í˜¸ { } ì•ˆì˜ ë‚´ìš©ë§Œ ì…ë ¥í•˜ì„¸ìš”');return;}
  localStorage.setItem('wp_fb_config',v);
  alert('ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤! í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•©ë‹ˆë‹¤.');
  location.reload();
}
function adminSaveFb() {
  const v=document.getElementById('adm-fb').value.trim();
  if(!v) return;
  try{JSON.parse(v);}catch(e){alert('JSON í˜•ì‹ ì˜¤ë¥˜');return;}
  localStorage.setItem('wp_fb_config',v);
  alert('ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤! í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•©ë‹ˆë‹¤.');
  location.reload();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function init() {
  const sl=localStorage.getItem('wp_locs');    if(sl) try{locations=JSON.parse(sl);}catch(e){}
  const sc=localStorage.getItem('wp_stats');   if(sc) try{const s=JSON.parse(sc);statsR=s.r||0;statsB=s.b||0;}catch(e){}
  const sa=localStorage.getItem('wp_active');  if(sa) try{activeAlerts=JSON.parse(sa);}catch(e){}
  const slog=localStorage.getItem('wp_log');   if(slog) try{alertLog=JSON.parse(slog);}catch(e){}
  const ss=localStorage.getItem('wp_staff');   if(ss) try{staffList=JSON.parse(ss);}catch(e){}

  const fbConf=localStorage.getItem('wp_fb_config');
  if(fbConf){
    document.getElementById('inp-fb').value=fbConf;
    document.getElementById('adm-fb').value=fbConf;
  }

  rebuildZoneSelect();
  buildLocGrid();
  rebuildMarkers();
  renderLog();
  updateStats();
  updateBanner();
  rebuildStaffList();
  rebuildLocEditList();

  initFirebase();
}

init();
</script>
</body>
</html>
